{% comment %}
  Product Gallery Pro - Main Gallery Block
  Reads settings from app metafields (shop.metafields.product_gallery_pro.settings)
{% endcomment %}

{% schema %}
{
  "name": "Product Gallery Pro",
  "target": "section",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": []
}
{% endschema %}

{% comment %} Read settings from shop metafield (set via app admin) {% endcomment %}
{% assign pgp_metafield = shop.metafields.product_gallery_pro.settings %}
{% assign has_app_settings = false %}
{% assign app_settings = nil %}

{% comment %} Default settings {% endcomment %}
{% assign layout = "carousel" %}
{% assign thumbnail_position = "bottom" %}
{% assign thumbnail_size = "medium" %}
{% assign enable_zoom = true %}
{% assign zoom_type = "both" %}
{% assign zoom_level = 2.5 %}
{% assign variant_filtering = true %}
{% assign lazy_loading = true %}
{% assign autoplay_video = false %}
{% assign enable_analytics = true %}
{% assign show_thumbnails = true %}
{% assign image_fit = "auto" %}

{% comment %} Parse app settings if metafield exists {% endcomment %}
{% if pgp_metafield != blank %}
  {% comment %}
    For JSON metafields, .value returns the parsed object directly.
    We access properties using dot notation or bracket notation.
  {% endcomment %}
  {% assign app_settings = pgp_metafield.value %}

  {% if app_settings != blank %}
    {% assign has_app_settings = true %}

    {% comment %} Apply each setting - use default filter for safety {% endcomment %}
    {% assign layout = app_settings.layout | default: layout %}
    {% assign thumbnail_position = app_settings.thumbnail_position | default: thumbnail_position %}
    {% assign thumbnail_size = app_settings.thumbnail_size | default: thumbnail_size %}

    {% comment %} Boolean settings need explicit checks {% endcomment %}
    {% if app_settings.enable_zoom == true %}
      {% assign enable_zoom = true %}
    {% elsif app_settings.enable_zoom == false %}
      {% assign enable_zoom = false %}
    {% endif %}

    {% assign zoom_type = app_settings.zoom_type | default: zoom_type %}

    {% if app_settings.zoom_level %}
      {% assign zoom_level = app_settings.zoom_level %}
    {% endif %}

    {% if app_settings.variant_filtering == true %}
      {% assign variant_filtering = true %}
    {% elsif app_settings.variant_filtering == false %}
      {% assign variant_filtering = false %}
    {% endif %}

    {% if app_settings.lazy_loading == true %}
      {% assign lazy_loading = true %}
    {% elsif app_settings.lazy_loading == false %}
      {% assign lazy_loading = false %}
    {% endif %}

    {% if app_settings.autoplay_video == true %}
      {% assign autoplay_video = true %}
    {% elsif app_settings.autoplay_video == false %}
      {% assign autoplay_video = false %}
    {% endif %}

    {% if app_settings.enable_analytics == true %}
      {% assign enable_analytics = true %}
    {% elsif app_settings.enable_analytics == false %}
      {% assign enable_analytics = false %}
    {% endif %}

    {% assign image_fit = app_settings.image_fit | default: image_fit %}

    {% comment %} Derive show_thumbnails from thumbnail_position {% endcomment %}
    {% if thumbnail_position == "none" %}
      {% assign show_thumbnails = false %}
    {% endif %}
  {% endif %}
{% endif %}

{% comment %} Thumbnail size classes {% endcomment %}
{% assign thumb_width = 60 %}
{% assign thumb_height = 60 %}
{% if thumbnail_size == "small" %}
  {% assign thumb_width = 50 %}
  {% assign thumb_height = 50 %}
{% elsif thumbnail_size == "large" %}
  {% assign thumb_width = 80 %}
  {% assign thumb_height = 80 %}
{% endif %}

<style>
  /* Hide native Dawn gallery immediately to prevent flicker */
  media-gallery,
  .product__media-wrapper media-gallery,
  slider-component.product__media-list {
    display: none !important;
    visibility: hidden !important;
  }
</style>

<div
  class="pgp-gallery pgp-layout-{{ layout }}"
  data-product-id="{{ product.id }}"
  data-layout="{{ layout }}"
  data-show-thumbnails="{{ show_thumbnails }}"
  data-thumb-position="{{ thumbnail_position }}"
  data-enable-zoom="{{ enable_zoom }}"
  data-zoom-type="{{ zoom_type }}"
  data-zoom-level="{{ zoom_level }}"
  data-variant-filtering="{{ variant_filtering }}"
  data-lazy-loading="{{ lazy_loading }}"
  data-autoplay-video="{{ autoplay_video }}"
  data-enable-analytics="{{ enable_analytics }}"
  data-image-fit="{{ image_fit }}"
  role="region"
  aria-label="Product image gallery"
>
  {% if layout == "stack" %}
    {% comment %} Stack layout - all images visible {% endcomment %}
    <div class="pgp-stack">
      {% for media in product.media %}
        <div
          class="pgp-stack-item"
          data-index="{{ forloop.index0 }}"
          data-media-id="{{ media.id }}"
          data-media-type="{{ media.media_type }}"
          {% if media.media_type == 'image' %}
            {% for variant in product.variants %}
              {% if variant.featured_media.id == media.id %}
                data-variant-id="{{ variant.id }}"
              {% endif %}
            {% endfor %}
          {% endif %}
        >
          {% case media.media_type %}
            {% when 'image' %}
              <img
                src="{{ media | image_url: width: 800 }}"
                data-high-res="{{ media | image_url: width: 1600 }}"
                alt="{{ media.alt | escape | default: product.title }}"
                loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                class="pgp-image"
                width="800"
                height="{{ 800 | divided_by: media.aspect_ratio | round }}"
              >
            {% when 'video', 'external_video' %}
              <div class="pgp-video-wrapper">
                {% if media.media_type == 'video' %}
                  {{ media | video_tag: autoplay: autoplay_video, loop: false, controls: true, muted: true }}
                {% else %}
                  {{ media | external_video_tag }}
                {% endif %}
              </div>
          {% endcase %}
        </div>
      {% endfor %}
    </div>

  {% elsif layout == "grid" %}
    {% comment %} Grid layout - images in a grid {% endcomment %}
    <div class="pgp-grid">
      {% for media in product.media %}
        <div
          class="pgp-grid-item"
          data-index="{{ forloop.index0 }}"
          data-media-id="{{ media.id }}"
          data-media-type="{{ media.media_type }}"
        >
          {% case media.media_type %}
            {% when 'image' %}
              <img
                src="{{ media | image_url: width: 600 }}"
                data-high-res="{{ media | image_url: width: 1600 }}"
                alt="{{ media.alt | escape | default: product.title }}"
                loading="{% if forloop.index <= 4 %}eager{% else %}lazy{% endif %}"
                class="pgp-image"
                width="600"
                height="{{ 600 | divided_by: media.aspect_ratio | round }}"
              >
            {% when 'video', 'external_video' %}
              <div class="pgp-video-wrapper">
                {% if media.media_type == 'video' %}
                  {{ media | video_tag: autoplay: autoplay_video, loop: false, controls: true, muted: true }}
                {% else %}
                  {{ media | external_video_tag }}
                {% endif %}
              </div>
          {% endcase %}
        </div>
      {% endfor %}
    </div>

  {% else %}
    {% comment %} Carousel layout (default) {% endcomment %}
    <div class="pgp-main-wrapper">
      <div class="pgp-main" id="pgp-main-slider">
        {% for media in product.media %}
          <div
            class="pgp-slide {% if forloop.first %}pgp-active{% endif %}"
            data-index="{{ forloop.index0 }}"
            data-media-id="{{ media.id }}"
            data-media-type="{{ media.media_type }}"
            {% if media.media_type == 'image' %}
              {% for variant in product.variants %}
                {% if variant.featured_media.id == media.id %}
                  data-variant-id="{{ variant.id }}"
                {% endif %}
              {% endfor %}
            {% endif %}
            role="group"
            aria-roledescription="slide"
            aria-label="{{ forloop.index }} of {{ product.media.size }}"
          >
            {% case media.media_type %}
              {% when 'image' %}
                <img
                  src="{{ media | image_url: width: 800 }}"
                  data-high-res="{{ media | image_url: width: 1600 }}"
                  alt="{{ media.alt | escape | default: product.title }}"
                  loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                  class="pgp-image"
                  width="800"
                  height="{{ 800 | divided_by: media.aspect_ratio | round }}"
                >
              {% when 'video', 'external_video' %}
                <div class="pgp-video-wrapper">
                  {% if media.media_type == 'video' %}
                    {{ media | video_tag: autoplay: autoplay_video, loop: false, controls: true, muted: true }}
                  {% else %}
                    {{ media | external_video_tag }}
                  {% endif %}
                </div>
            {% endcase %}
          </div>
        {% endfor %}
      </div>
      {% if product.media.size > 1 %}
        <button class="pgp-nav pgp-prev" aria-label="Previous image" aria-controls="pgp-main-slider">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <span class="pgp-counter">1/{{ product.media.size }}</span>
        <button class="pgp-nav pgp-next" aria-label="Next image" aria-controls="pgp-main-slider">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      {% endif %}
    </div>

    {% if show_thumbnails and product.media.size > 1 %}
      <div
        class="pgp-thumbnails pgp-thumbnails--{{ thumbnail_position }} pgp-thumbnails--{{ thumbnail_size }}"
        role="tablist"
        aria-label="Image thumbnails"
      >
        {% for media in product.media %}
          <button
            class="pgp-thumb {% if forloop.first %}pgp-thumb--active{% endif %}"
            data-index="{{ forloop.index0 }}"
            data-media-id="{{ media.id }}"
            role="tab"
            aria-label="View image {{ forloop.index }}"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
          >
            <img
              src="{{ media.preview_image | image_url: width: 150 }}"
              alt=""
              loading="lazy"
              width="{{ thumb_width }}"
              height="{{ thumb_height }}"
            >
          </button>
        {% endfor %}
      </div>
    {% endif %}
  {% endif %}
</div>

<link rel="stylesheet" href="{{ 'gallery.css' | asset_url }}" />
<script>
  // Pass metafield value directly to JavaScript for parsing
  var _pgpMetafieldValue = {{ pgp_metafield.value | json }};

  // Parse settings from metafield if available
  var _pgpSettings = (function() {
    var defaults = {
      layout: "carousel",
      showThumbnails: true,
      thumbnailPosition: "bottom",
      thumbnailSize: "medium",
      enableZoom: true,
      zoomType: "both",
      zoomLevel: 2.5,
      variantFiltering: true,
      lazyLoading: true,
      autoplayVideo: false,
      enableAnalytics: true,
      imageFit: "auto"
    };

    if (!_pgpMetafieldValue || typeof _pgpMetafieldValue !== 'object') {
      return defaults;
    }

    return {
      layout: _pgpMetafieldValue.layout || defaults.layout,
      showThumbnails: _pgpMetafieldValue.thumbnail_position !== "none",
      thumbnailPosition: _pgpMetafieldValue.thumbnail_position || defaults.thumbnailPosition,
      thumbnailSize: _pgpMetafieldValue.thumbnail_size || defaults.thumbnailSize,
      enableZoom: _pgpMetafieldValue.enable_zoom !== undefined ? _pgpMetafieldValue.enable_zoom : defaults.enableZoom,
      zoomType: _pgpMetafieldValue.zoom_type || defaults.zoomType,
      zoomLevel: _pgpMetafieldValue.zoom_level || defaults.zoomLevel,
      variantFiltering: _pgpMetafieldValue.variant_filtering !== undefined ? _pgpMetafieldValue.variant_filtering : defaults.variantFiltering,
      lazyLoading: _pgpMetafieldValue.lazy_loading !== undefined ? _pgpMetafieldValue.lazy_loading : defaults.lazyLoading,
      autoplayVideo: _pgpMetafieldValue.autoplay_video !== undefined ? _pgpMetafieldValue.autoplay_video : defaults.autoplayVideo,
      enableAnalytics: _pgpMetafieldValue.enable_analytics !== undefined ? _pgpMetafieldValue.enable_analytics : defaults.enableAnalytics,
      imageFit: _pgpMetafieldValue.image_fit || defaults.imageFit
    };
  })();

  // Variant image mapping from product metafield
  var _pgpVariantImageMap = {{ product.metafields.product_gallery_pro.variant_image_map.value | json }};

  // Build variant ID -> option values lookup
  var _pgpVariants = {};
  {% for variant in product.variants %}
    _pgpVariants[{{ variant.id | json }}] = [
      {%- for option in variant.options -%}
        {{ option | json }}{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ];
  {% endfor %}

  // Rules from shop metafield
  var _pgpRulesData = null;
  {% assign pgp_rules_meta = shop.metafields.product_gallery_pro.rules %}
  {% if pgp_rules_meta != blank and pgp_rules_meta.value != blank %}
    var _pgpRulesRaw = {{ pgp_rules_meta.value | json }};
    if (_pgpRulesRaw) {
      if (typeof _pgpRulesRaw === 'object') {
        _pgpRulesData = _pgpRulesRaw;
      } else if (typeof _pgpRulesRaw === 'string') {
        try { _pgpRulesData = JSON.parse(_pgpRulesRaw); } catch(e) {}
      }
    }
  {% endif %}

  window.PGPConfig = {
    productId: {{ product.id | json }},
    defaultVariantId: {{ product.selected_or_first_available_variant.id | json }},
    settings: _pgpSettings,
    hasAppSettings: _pgpMetafieldValue && typeof _pgpMetafieldValue === 'object',
    _rawMetafield: _pgpMetafieldValue,
    variantImageMap: _pgpVariantImageMap || null,
    variants: _pgpVariants,
    rulesData: _pgpRulesData
  };

  // Inject tags and universal flag from variant mapping into slide DOM
  (function() {
    var map = window.PGPConfig.variantImageMap;
    if (!map || !map.mappings) return;

    function numericId(id) {
      return (typeof id === 'string' && id.indexOf('/') !== -1) ? id.split('/').pop() : String(id);
    }

    for (var gid in map.mappings) {
      var m = map.mappings[gid];
      var nid = numericId(gid);
      var slide = document.querySelector('.pgp-slide[data-media-id="' + nid + '"]')
               || document.querySelector('.pgp-stack-item[data-media-id="' + nid + '"]')
               || document.querySelector('.pgp-grid-item[data-media-id="' + nid + '"]');
      if (!slide) continue;

      if (m.tags && m.tags.length > 0) {
        slide.dataset.tags = m.tags.join(',');
      }
      if (m.universal) {
        slide.dataset.universal = 'true';
      }
      if (m.variants && m.variants.length > 0) {
        slide.dataset.variants = m.variants.join(',');
      }
    }
  })();

  // Pre-filter: immediately hide non-matching slides/thumbs to prevent flash.
  // Does NOT reorder DOM â€” gallery.js handles ordering via its activeIds array.
  (function() {
    var params = new URLSearchParams(window.location.search);
    var variantId = params.get('variant') || String(window.PGPConfig.defaultVariantId || '');
    if (!variantId) return;

    var map = window.PGPConfig.variantImageMap;
    var variants = window.PGPConfig.variants || {};
    var optionValues = variants[String(variantId)] || [];
    if (!map || !map.mappings || optionValues.length === 0) return;

    var mappings = map.mappings;
    var matchMode = (map.settings && map.settings.match_mode) || 'any';

    function numericId(id) {
      return (typeof id === 'string' && id.indexOf('/') !== -1) ? id.split('/').pop() : String(id);
    }

    // Determine allowed media IDs
    var allowed = {};
    var bestPos = Infinity; // track which allowed media has lowest position
    var firstMediaId = null;
    for (var mid in mappings) {
      var m = mappings[mid];
      var nid = numericId(mid);
      var isAllowed = false;

      if (m.universal) {
        isAllowed = true;
      } else {
        var mv = m.variants || [];
        if (mv.length > 0) {
          var hit = matchMode === 'all'
            ? optionValues.every(function(o) { return mv.indexOf(o) !== -1; })
            : optionValues.some(function(o) { return mv.indexOf(o) !== -1; });
          if (hit) isAllowed = true;
        }
      }

      if (isAllowed) {
        allowed[nid] = true;
        var pos = (typeof m.position === 'number') ? m.position : 9999;
        if (pos < bestPos) {
          bestPos = pos;
          firstMediaId = nid;
        }
      }
    }

    var hasAny = false;
    for (var k in allowed) { hasAny = true; break; }
    if (!hasAny) return;

    // Ensure the first-by-position image loads immediately.
    // Liquid sets eager on product.media[0], which may differ from the variant's first image.
    // removeAttribute('loading') lifts the lazy constraint so the browser re-evaluates.
    // <link rel="preload"> ensures highest-priority fetch regardless of preload scanner state.
    if (firstMediaId) {
      var firstSlide = document.querySelector('.pgp-slide[data-media-id="' + firstMediaId + '"]');
      if (firstSlide) {
        var img = firstSlide.querySelector('img');
        if (img) {
          img.removeAttribute('loading');
          var link = document.createElement('link');
          link.rel = 'preload';
          link.as = 'image';
          link.href = img.src;
          document.head.appendChild(link);
        }
      }
    }

    // Show only the first-by-position slide as active; CSS hides the rest
    // via .pgp-slide { display: none } / .pgp-slide.pgp-active { display: block }.
    var matchCount = 0;
    document.querySelectorAll('.pgp-slide').forEach(function(s) {
      var mid = s.dataset.mediaId;
      if (allowed[mid]) {
        matchCount++;
        if (mid === firstMediaId) {
          s.classList.add('pgp-active');
        } else {
          s.classList.remove('pgp-active');
        }
      } else {
        s.classList.remove('pgp-active');
      }
    });

    // Hide non-matching thumbnails
    document.querySelectorAll('.pgp-thumb').forEach(function(t) {
      var mid = t.dataset.mediaId;
      if (mid) {
        t.style.display = allowed[mid] ? '' : 'none';
        t.classList.toggle('pgp-thumb--active', mid === firstMediaId);
      }
    });

    // Update counter
    var ctr = document.querySelector('.pgp-counter');
    if (ctr) ctr.textContent = '1/' + matchCount;
  })();
</script>
<link rel="stylesheet" href="{{ 'rules-badges.css' | asset_url }}">
<script src="{{ 'rules-evaluator.js' | asset_url }}" defer></script>
<script src="{{ 'gallery.js' | asset_url }}" defer></script>
{% if enable_zoom %}
  <link rel="stylesheet" href="{{ 'enhancer.css' | asset_url }}">
  <script src="{{ 'enhancer.js' | asset_url }}" defer></script>
{% endif %}
{% if enable_analytics %}
  <script src="{{ 'analytics.js' | asset_url }}" defer></script>
{% endif %}
